debug_mode=true;function getFile(b,c){if(debug_mode){console.log("downloading "+b)}var a=null;if(window.XMLHttpRequest){a=new XMLHttpRequest()}else{if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLHTTP")}else{alert("Votre navigateur ne supporte pas les objets XMLHTTPRequest...");return}}a.onreadystatechange=function(){if(a.readyState==4){if(debug_mode){console.log(b+" complete!")}c(a.responseText)}};a.open("GET",b,true);a.send(null)}function unzipBlob(a,b){zip.createReader(new zip.BlobReader(a),function(c){c.getEntries(function(d){d[0].getData(new zip.BlobWriter(zip.getMimeType(d[0].filename)),function(e){c.close();b(e)})})},function(c){if(debug_mode){console.error(c)}})}function getZipFile(a,b){zip.workerScriptsPath="plugins/zip/";var c=new XMLHttpRequest();c.open("GET",a,true);c.responseType="blob";c.onload=function(g){if(this.status==200){var f=new Blob([this.response],{type:"zip"});unzipBlob(f,d)}};function d(f){var e=new FileReader();e.onload=function(g){b(g.target.result)};e.readAsText(f)}c.send()}function getZipFileWS(b,d,c){zip.workerScriptsPath="plugins/zip/";var a=localStorage.getItem(c);if(a!=null){if(debug_mode){console.log("Getting "+c+" file")}d(a)}else{var e=new XMLHttpRequest();e.open("GET",b,true);e.responseType="blob";e.onload=function(h){if(this.status==200){var g=new Blob([this.response],{type:"zip"});unzipBlob(g,f)}};e.send()}function f(h){var g=new FileReader();g.onload=function(k){try{localStorage.setItem(c,k.target.result)}catch(i){if(debug_mode){console.log(i.message)}}d(k.target.result)};g.readAsText(h)}}function load(){if(debug_mode){console.log("loading data and starting app!")}createMap();getZipFile("data/Toulouse/stops.zip",onStopsLoaded);getZipFile("data/Toulouse/routes.zip",onRoutesLoaded);getZipFile("data/Toulouse/shapes.zip",onShapesLoaded);getZipFile("data/Toulouse/calendar.zip",onCalendarLoaded);getZipFile("data/Toulouse/calendar_dates.zip",onCalendar_datesLoaded);getZipFile("data/Toulouse/DWalk.zip",onDWalkLoaded);getZipFile("data/Toulouse/trips.zip",onTripsLoaded);getZipFile("data/Toulouse/stop_times.zip",onStop_timesLoaded);getZipFile("data/Toulouse/frequencies.zip",onFrequenciesLoaded)}function loadWS(){if(debug_mode){console.log("loading data and starting app!")}createMap();getFile("data/Toulouse/download_date.txt",onDownload_dateLoaded)}function getZipFiles(){getZipFileWS("data/Toulouse/stops.zip",onStopsLoaded,"stops");getZipFileWS("data/Toulouse/routes.zip",onRoutesLoaded,"routes");getZipFileWS("data/Toulouse/shapes.zip",onShapesLoaded,"shapes");getZipFileWS("data/Toulouse/calendar.zip",onCalendarLoaded,"calendar");getZipFileWS("data/Toulouse/calendar_dates.zip",onCalendar_datesLoaded,"calendar_dates");getZipFileWS("data/Toulouse/DWalk.zip",onDWalkLoaded,"DWalk");getZipFileWS("data/Toulouse/trips.zip",onTripsLoaded,"trips");getZipFileWS("data/Toulouse/stop_times.zip",onStop_timesLoaded,"stop_times");getZipFileWS("data/Toulouse/frequencies.zip",onFrequenciesLoaded,"frequencies")}function onDownload_dateLoaded(c){var a=new Date(c);try{var b=localStorage.getItem("download_date");if(b!=null){var e=new Date(b);if(debug_mode){console.log(e+" "+a)}if(a.getTime()!=e.getTime()){if(debug_mode){console.log("Removing files")}localStorage.clear();localStorage.setItem("download_date",a)}}else{localStorage.setItem("download_date",a)}}catch(d){if(debug_mode){console.log(d.message)}if(debug_mode){console.log("no local storage available or problem getting download_date")}if(debug_mode){console.log("Removing files")}localStorage.clear();localStorage.setItem("download_date",a)}getZipFiles()}function onStopsLoaded(e){stops=new Array;stopIndex=new Array;stopName2id=new Array;var a=e.split(RegExp("\n","g"));for(var d=1;d<a.length;d++){if(a[d].length>0){var g=a[d].trim().split(RegExp(",","g"));var h=stops.length;var b=String(g[0]);stopIndex[b]=h;var c=L.latLng(Number(g[3]),Number(g[4]));c.isActive=true;c.originalId=b;c.name=String(g[2]);c.code=String(g[1]);c.parentStation=(g.length>6)?String(g[6]):"";c.subRoutes=new Array;c.childStations=new Array;c.myName=c.name+" "+c.code;if(c.myName in stopName2id){var f=1;for(j in stopName2id){if(j==c.myName+(f==1?"":" "+f)){++f}}c.myName=c.myName+" "+f}stops.push(c);stopName2id[c.myName]=h}}for(var d=0;d<stops.length;d++){if(stops[d].parentStation!=""){stops[stopIndex[stops[d].parentStation]].childStations.push(d)}}if(debug_mode){console.log("onStopsLoaded finished!")}onDWalkLoaded();onStop_timesLoaded()}function onRoutesLoaded(e){if(debug_mode){var f=performance.now()}routes=new Array;routeIndex=new Array;var g=Papa.parse(e,{delimiter:",",header:false,dynamicTyping:false,preview:0,step:undefined,encoding:"",worker:false,comments:false,complete:undefined,error:undefined,download:false,keepEmptyRows:false,chunk:undefined}).data;for(var d=1;d<g.length;d++){var b=g[d];var h=routes.length;var a=String(b[0]);routeIndex[a]=h;var c=new Object;c.originalId=a;c.shortName=b[2];c.longName=b[3];c.type=String(b[5]);c.subRoutes=new Array;routes.push(c)}if(debug_mode){console.log("onRoutesLoaded finished!")}if(debug_mode){console.log("onRoutesLoaded: "+(performance.now()-f))}onTripsLoaded()}function onShapesLoaded(e){shapes=new Array;shapeIndex=new Array;var a=e.split(RegExp("\n","g"));if(debug_mode){console.log("onShapesLoaded : "+a.length)}for(var d=1;d<a.length;d++){if(a[d].length>0){var f=a[d].split(RegExp(",","g"));var b=String(f[0]);var g=0;if(b in shapeIndex){g=shapeIndex[b]}else{var c=new Object;c.originalId=b;c.stops=new Array;g=shapes.length;shapes.push(c);shapeIndex[b]=g}shapes[g].stops[Number(f[3])]=new L.latLng(Number(f[1]),Number(f[2]))}}if(debug_mode){console.log("onShapesLoaded finished!")}onTripsLoaded()}function onCalendarLoaded(e){services=new Array;serviceIndex=new Array;var a=e.split(RegExp("\n","g"));for(var d=1;d<a.length;d++){if(a[d].length>0){var g=a[d].split(RegExp(",","g"));var h=services.length;var b=String(g[0]);serviceIndex[b]=h;var f=new Object;f.originalId=b;f.isOnByDay=new Array(7);for(var c=0;c<7;c++){f.isOnByDay[c]=(Number(g[1+c])==1)}f.startDate=String(g[8]);f.endDate=String(g[9]);f.exceptions=new Array;services.push(f)}}if(debug_mode){console.log("onCalendarLoaded finished!")}onTripsLoaded();onCalendar_datesLoaded()}var _calendar_datesLoaded=0;var fileCalendar_dates;function onCalendar_datesLoaded(d){if(d!=undefined){fileCalendar_dates=d}if(++_calendar_datesLoaded>=2){var a=fileCalendar_dates.split(RegExp("\n","g"));for(var c=1;c<a.length;c++){if(a[c].length>0){var e=a[c].split(RegExp(",","g"));var f=serviceIndex[String(e[0])];var b=String(e[1]);services[f].exceptions[b]=Number(e[2])}}if(debug_mode){console.log("onCalendar_datesLoaded finished!")}}}var _DWalkLoaded=0;var fileDWalk;function onDWalkLoaded(c){if(c!=undefined){fileDWalk=c}if(++_DWalkLoaded>=2){dWalk=new Array;for(var b=0;b<stops.length;b++){dWalk[b]=new Array}var a=fileDWalk.split(RegExp("\n","g"));if(debug_mode){console.log("onDWalkLoaded : "+a.length)}for(var b=1;b<a.length;b++){if(a[b].length>0){var d=a[b].split(RegExp(";","g"));if(stopIndex[d[0]]!==undefined&&stopIndex[d[1]]!==undefined){if(d[3]=="n/a"){dWalk[stopIndex[d[0]]][stopIndex[d[1]]]=10/3600;dWalk[stopIndex[d[1]]][stopIndex[d[0]]]=10/3600}else{dWalk[stopIndex[d[0]]][stopIndex[d[1]]]=Number(d[4])/3600;dWalk[stopIndex[d[1]]][stopIndex[d[0]]]=Number(d[4])/3600}}}}if(debug_mode){console.log("onDWalkLoaded finished!")}}}var _tripsLoaded=0;var fileTrips;function onTripsLoaded(c){if(debug_mode){var d=performance.now()}if(c!=undefined){fileTrips=c}if(++_tripsLoaded==4){var a=fileTrips.split(RegExp("\n","g"));if(debug_mode){console.log("onTripsLoaded : "+a.length)}_trips=new Array;_tripIndex=new Array;for(var b=1;b<a.length;b++){if(a[b].length>0){var f=a[b].split(RegExp(",","g"));var e=String(f[0]);_tripIndex[e]=b-1;newTrip=new Object;newTrip.serviceId=serviceIndex[String(f[1])];newTrip.routeId=routeIndex[String(f[2])];newTrip.shapeId=shapeIndex[String(f[5])];newTrip.stops=new Array;newTrip.times=new Array;newTrip.frequency={freq:NaN,startTime:0,endTime:0};_trips.push(newTrip)}}if(debug_mode){console.log("onTripsLoaded finished!")}if(debug_mode){console.log("onTripsLoaded: "+(performance.now()-d))}onStop_timesLoaded();affRoutes()}}var _Stop_timesLoaded=0;var fileStop_times;function onStop_timesLoaded(c){if(c!=undefined){fileStop_times=c}if(++_Stop_timesLoaded>=3){var a=fileStop_times.split(RegExp("\n","g"));for(var b=1;b<a.length;b++){if(a[b].length>0){var f=a[b].split(RegExp(",","g"));var e=_tripIndex[String(f[0])];var d=Number(f[2]);_trips[e].stops[d]=stopIndex[String(f[1])];_trips[e].times[d]=readTime(String(f[3]))}}if(debug_mode){console.log("onStop_timesLoaded finished!")}onFrequenciesLoaded()}}var _FrequenciesLoaded=0;var fileFrequencies;function onFrequenciesLoaded(d){if(d!=undefined){fileFrequencies=d}if(++_FrequenciesLoaded>=2){var a=fileFrequencies.split(RegExp("\n","g"));for(var c=1;c<a.length;c++){if(a[c].length>0){var g=a[c].split(RegExp(",","g"));var f=_tripIndex[String(g[0])];var e=readTime(String(g[1]));var b=readTime(String(g[2]));if((_trips[f].times[0]>=e)&&(_trips[f].times[0]<=b)){_trips[f].frequency={freq:Number(g[3])/3600,startTime:e,endTime:b}}}}if(debug_mode){console.log("onFrequenciesLoaded finished!")}createSubRoutes()}};